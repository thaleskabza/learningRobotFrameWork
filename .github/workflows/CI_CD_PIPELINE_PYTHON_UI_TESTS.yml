name: Robot Framework UI Automation Tests

on:
  schedule:
    - cron: '30 6 * * *'     # daily at 06:30 UTC
  push:
    branches: [ main, master, dev, feature ]
  pull_request:
    branches: [ main, master, dev, feature ]

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # make these available to every step
    env:
      DOCKER_BUILDKIT: 1
      ROBOT_REPORTS: reports

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Docker Compose plugin
        run: |
          sudo apt-get update
          

      - name: Build Docker images
        run: docker compose build --no-cache

      - name: Start Selenium Hub and browser nodes
        run: docker compose up -d
        timeout-minutes: 5

      - name: Wait for Selenium Hub to be ready
        run: |
          echo "Waiting for Selenium Hub..."
          for i in {1..20}; do
            if curl -s http://localhost:4444/wd/hub/status | grep -q '"ready":true'; then
              echo "‚úÖ Selenium Hub is ready"
              exit 0
            fi
            echo "  still waiting‚Ä¶"
            sleep 3
          done
          echo "‚ùå Selenium Hub failed to start in time"
          exit 1

      - name: Run Robot Framework tests
        run: |
          echo "üîç Running Robot Framework tests‚Ä¶"
          mkdir -p "$ROBOT_REPORTS"
          docker compose run --rm test-runner \
            robot --outputdir "$ROBOT_REPORTS" tests/
        continue-on-error: true

      - name: Tear down services
        if: always()
        run: docker compose down -v

      - name: List generated Robot reports
        if: always()
        run: |
          echo "üìÇ Contents of $ROBOT_REPORTS:"
          ls -R "$ROBOT_REPORTS" || echo "No reports found."

      - name: Upload Robot reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-reports
          path: ${{ env.ROBOT_REPORTS }}
          retention-days: 7
